<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>glitch-network</title>
<style>
  html,body { margin:0; height:100%; background:#000; overflow:hidden; }
  canvas { display:block; width:100vw; height:100vh; }
  #ui { position:fixed; top:10px; left:10px; color:#fff; font-family:monospace; font-size:14px; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">ðŸŽµ Drop audio or press space for mic</div>
<script>
const canvas=document.getElementById("c"),ctx=canvas.getContext("2d");
let W,H,DPR=Math.max(1,Math.min(window.devicePixelRatio||1,2));
function resize(){W=canvas.width=innerWidth*DPR;H=canvas.height=innerHeight*DPR;}
addEventListener("resize",resize);resize();

// --- audio setup ---
let actx,analyser,dataArray,srcNode,started=false;
async function initAudioMic(){
  if(!actx){actx=new AudioContext();analyser=actx.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}
  const stream=await navigator.mediaDevices.getUserMedia({audio:true});
  srcNode=actx.createMediaStreamSource(stream);srcNode.connect(analyser);started=true;
}
async function initAudioFile(file){
  if(!actx){actx=new AudioContext();analyser=actx.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}
  const buf=await file.arrayBuffer();const audio=await actx.decodeAudioData(buf);
  const bs=actx.createBufferSource();bs.buffer=audio;bs.loop=true;bs.connect(analyser);bs.connect(actx.destination);bs.start();started=true;
}
addEventListener("keydown",e=>{if(e.code==="Space"){initAudioMic();}});
addEventListener("drop",e=>{e.preventDefault();if(e.dataTransfer.files[0])initAudioFile(e.dataTransfer.files[0]);});
addEventListener("dragover",e=>e.preventDefault());

// --- particles ---
const N=120, nodes=[];
for(let i=0;i<N;i++){nodes.push({x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-0.5)*2,vy:(Math.random()-0.5)*2,r:2+Math.random()*3});}

function stepAudio(){
  if(!started) return 0;
  analyser.getByteFrequencyData(dataArray);
  let avg=0;for(let i=0;i<dataArray.length;i++)avg+=dataArray[i];avg/=dataArray.length;
  return avg/255; // 0..1
}

function draw(){
  ctx.fillStyle="rgba(0,0,0,0.25)";ctx.fillRect(0,0,W,H);
  let energy=stepAudio();
  for(let n of nodes){
    // jitter / glitch
    if(Math.random()<0.02+energy*0.05){n.vx+=(Math.random()-0.5)*8*energy;n.vy+=(Math.random()-0.5)*8*energy;}
    n.x+=n.vx;n.y+=n.vy;
    if(n.x<0||n.x>W){n.vx*=-1;}
    if(n.y<0||n.y>H){n.vy*=-1;}
    // draw node
    ctx.beginPath();ctx.arc(n.x,n.y,n.r,0,Math.PI*2);
    ctx.fillStyle=`hsl(${200+energy*160},80%,${50+energy*40}%)`;
    ctx.fill();
  }
  // draw edges
  ctx.lineWidth=1+energy*2;ctx.strokeStyle=`rgba(180,200,255,${0.2+energy*0.5})`;
  for(let i=0;i<N;i++){for(let j=i+1;j<N;j++){
    let dx=nodes[i].x-nodes[j].x,dy=nodes[i].y-nodes[j].y,dist=Math.hypot(dx,dy);
    if(dist<120+energy*200){
      ctx.globalAlpha=1-dist/(200+energy*300);
      ctx.beginPath();ctx.moveTo(nodes[i].x,nodes[i].y);ctx.lineTo(nodes[j].x,nodes[j].y);ctx.stroke();
    }
  }}ctx.globalAlpha=1;
  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>
